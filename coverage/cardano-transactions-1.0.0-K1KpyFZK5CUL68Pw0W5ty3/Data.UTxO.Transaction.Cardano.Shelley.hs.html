<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="decl"><span class="nottickedoff">never executed</span> <span class="tickonlytrue">always true</span> <span class="tickonlyfalse">always false</span></span>
</pre>
<pre>
<span class="lineno">    1 </span>{-# LANGUAGE DataKinds #-}
<span class="lineno">    2 </span>{-# LANGUAGE GeneralizedNewtypeDeriving #-}
<span class="lineno">    3 </span>{-# LANGUAGE InstanceSigs #-}
<span class="lineno">    4 </span>{-# LANGUAGE LambdaCase #-}
<span class="lineno">    5 </span>{-# LANGUAGE OverloadedStrings #-}
<span class="lineno">    6 </span>{-# LANGUAGE RankNTypes #-}
<span class="lineno">    7 </span>{-# LANGUAGE ScopedTypeVariables #-}
<span class="lineno">    8 </span>{-# LANGUAGE TypeFamilies #-}
<span class="lineno">    9 </span>
<span class="lineno">   10 </span>{-# OPTIONS_HADDOCK prune #-}
<span class="lineno">   11 </span>
<span class="lineno">   12 </span>module Data.UTxO.Transaction.Cardano.Shelley
<span class="lineno">   13 </span>    (
<span class="lineno">   14 </span>    -- * Initialization
<span class="lineno">   15 </span>      mkInit
<span class="lineno">   16 </span>
<span class="lineno">   17 </span>    -- * Types
<span class="lineno">   18 </span>    , NetworkId (..)
<span class="lineno">   19 </span>    , NetworkMagic (..)
<span class="lineno">   20 </span>    , Fee (..)
<span class="lineno">   21 </span>    , AddrAttributes
<span class="lineno">   22 </span>
<span class="lineno">   23 </span>   -- * Constructing Primitives
<span class="lineno">   24 </span>    , mkInput
<span class="lineno">   25 </span>    , mkOutput
<span class="lineno">   26 </span>    , mkShelleySignKey
<span class="lineno">   27 </span>    , mkByronSignKey
<span class="lineno">   28 </span>    , mkAddrAttributes
<span class="lineno">   29 </span>
<span class="lineno">   30 </span>    -- Internal
<span class="lineno">   31 </span>    , Shelley
<span class="lineno">   32 </span>    ) where
<span class="lineno">   33 </span>
<span class="lineno">   34 </span>
<span class="lineno">   35 </span>import Cardano.Address.Byron
<span class="lineno">   36 </span>    ( AddrAttributes, Address (..), getAddrAttributes, mkAttributes )
<span class="lineno">   37 </span>import Cardano.Api.Typed
<span class="lineno">   38 </span>    ( NetworkId
<span class="lineno">   39 </span>    , NetworkMagic (..)
<span class="lineno">   40 </span>    , TxExtraContent (..)
<span class="lineno">   41 </span>    , TxIn (..)
<span class="lineno">   42 </span>    , TxOut (..)
<span class="lineno">   43 </span>    )
<span class="lineno">   44 </span>import Cardano.Crypto.Extra
<span class="lineno">   45 </span>    ( xprvFromBytes )
<span class="lineno">   46 </span>import Cardano.Crypto.Hash.Class
<span class="lineno">   47 </span>    ( Hash (UnsafeHash) )
<span class="lineno">   48 </span>import Cardano.Crypto.Signing
<span class="lineno">   49 </span>    ( SigningKey (..) )
<span class="lineno">   50 </span>import Cardano.Slotting.Slot
<span class="lineno">   51 </span>    ( SlotNo (..) )
<span class="lineno">   52 </span>import Data.ByteString
<span class="lineno">   53 </span>    ( ByteString )
<span class="lineno">   54 </span>import Data.ByteString.Short
<span class="lineno">   55 </span>    ( toShort )
<span class="lineno">   56 </span>import Data.UTxO.Transaction
<span class="lineno">   57 </span>    ( ErrMkPayment (..), MkPayment (..) )
<span class="lineno">   58 </span>import Data.Word
<span class="lineno">   59 </span>    ( Word32 )
<span class="lineno">   60 </span>import Numeric.Natural
<span class="lineno">   61 </span>    ( Natural )
<span class="lineno">   62 </span>
<span class="lineno">   63 </span>import qualified Cardano.Api.Typed as Cardano
<span class="lineno">   64 </span>import qualified Data.ByteString as BS
<span class="lineno">   65 </span>import qualified Shelley.Spec.Ledger.Address.Bootstrap as Ledger
<span class="lineno">   66 </span>import qualified Shelley.Spec.Ledger.Credential as Ledger
<span class="lineno">   67 </span>import qualified Shelley.Spec.Ledger.TxBody as Ledger
<span class="lineno">   68 </span>
<span class="lineno">   69 </span>
<span class="lineno">   70 </span>-- | A type isomorphic to 'Integer' to represent fees.
<span class="lineno">   71 </span>newtype Fee = Fee { <span class="istickedoff"><span class="decl"><span class="istickedoff">unFee</span></span></span> :: Integer }
<span class="lineno">   72 </span>    deriving (<span class="decl"><span class="nottickedoff">Show</span></span>, <span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Eq</span></span></span></span>, <span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="istickedoff">Num</span></span></span></span></span></span></span></span></span></span></span></span></span></span>)
<span class="lineno">   73 </span>
<span class="lineno">   74 </span>-- | A type to capture signing keys in Shelley. In order to produce Byron
<span class="lineno">   75 </span>-- witnesses, one needs to include extra information that are present in the
<span class="lineno">   76 </span>-- source input address.
<span class="lineno">   77 </span>data CardanoSigningKey
<span class="lineno">   78 </span>    = ShelleySigningKey Cardano.ShelleyWitnessSigningKey
<span class="lineno">   79 </span>    | ByronSigningKey AddrAttributes SigningKey
<span class="lineno">   80 </span>
<span class="lineno">   81 </span>-- | Construct a payment 'Init' for /Shelley/ from primitive types.
<span class="lineno">   82 </span>--
<span class="lineno">   83 </span>-- __examples__:
<span class="lineno">   84 </span>--
<span class="lineno">   85 </span>-- &gt;&gt;&gt; mkInit Mainnet 430000
<span class="lineno">   86 </span>-- &gt;&gt;&gt; mkInit (Testnet (NetworkMagic 1234)) 430000
<span class="lineno">   87 </span>--
<span class="lineno">   88 </span>-- @since 2.0.0
<span class="lineno">   89 </span>mkInit
<span class="lineno">   90 </span>    :: NetworkId
<span class="lineno">   91 </span>        -- ^ A network tag, Mainnet or Testnet with NetworkMagic specified
<span class="lineno">   92 </span>    -&gt; SlotNo
<span class="lineno">   93 </span>        -- ^ A ttl expressed in slot number counted from the beginning of blockchain
<span class="lineno">   94 </span>    -&gt; Fee
<span class="lineno">   95 </span>        -- ^ fee of tx as taken when constructing change outputs
<span class="lineno">   96 </span>    -&gt; Init Shelley
<span class="lineno">   97 </span><span class="decl"><span class="istickedoff">mkInit net ttl fee = (<span class="nottickedoff">net</span>, ttl, fee)</span></span>
<span class="lineno">   98 </span>
<span class="lineno">   99 </span>-- | Construct a payment 'Input' for /Shelley/ from primitive types.
<span class="lineno">  100 </span>--
<span class="lineno">  101 </span>-- __example__:
<span class="lineno">  102 </span>--
<span class="lineno">  103 </span>-- &gt;&gt;&gt; mkInput 14 =&lt;&lt; fromBase16 &quot;3b402651...aad1c0b7&quot;
<span class="lineno">  104 </span>-- Just (Input ...)
<span class="lineno">  105 </span>--
<span class="lineno">  106 </span>-- @since 2.0.0
<span class="lineno">  107 </span>mkInput
<span class="lineno">  108 </span>    :: Word32
<span class="lineno">  109 </span>        -- ^ Input index.
<span class="lineno">  110 </span>    -&gt; ByteString
<span class="lineno">  111 </span>        -- ^ Input transaction id. See also: 'fromBase16'.
<span class="lineno">  112 </span>    -&gt; Maybe (Input Shelley)
<span class="lineno">  113 </span><span class="decl"><span class="istickedoff">mkInput ix bytes =</span>
<span class="lineno">  114 </span><span class="spaces">    </span><span class="istickedoff">if BS.length bytes == 32 then</span>
<span class="lineno">  115 </span><span class="spaces">        </span><span class="istickedoff">Just $ Cardano.TxIn</span>
<span class="lineno">  116 </span><span class="spaces">            </span><span class="istickedoff">(Cardano.TxId $ UnsafeHash $ toShort bytes)</span>
<span class="lineno">  117 </span><span class="spaces">            </span><span class="istickedoff">(Cardano.TxIx (fromIntegral ix))</span>
<span class="lineno">  118 </span><span class="spaces">    </span><span class="istickedoff">else</span>
<span class="lineno">  119 </span><span class="spaces">        </span><span class="istickedoff">Nothing</span></span>
<span class="lineno">  120 </span>
<span class="lineno">  121 </span>-- | Construct a payment 'Output' for /Shelley/ from primitive types.
<span class="lineno">  122 </span>--
<span class="lineno">  123 </span>-- __example__:
<span class="lineno">  124 </span>--
<span class="lineno">  125 </span>-- &gt;&gt;&gt; mkOutput 42 =&lt;&lt; fromBase58 &quot;Ae2tdPwU...DnXy319f&quot;
<span class="lineno">  126 </span>-- &gt;&gt;&gt; mkOutput 42 =&lt;&lt; fromBech32 &quot;addr1sjc...6s3xvu5g&quot;
<span class="lineno">  127 </span>-- &gt;&gt;&gt; mkOutput 42 =&lt;&lt; fromBase16 &quot;42bf330c...ba5b947e&quot;
<span class="lineno">  128 </span>-- Just (Output ...)
<span class="lineno">  129 </span>--
<span class="lineno">  130 </span>-- @since 2.0.0
<span class="lineno">  131 </span>mkOutput
<span class="lineno">  132 </span>    :: Natural
<span class="lineno">  133 </span>        -- ^ Output value, in Lovelace (1 Ada = 1e6 Lovelace).
<span class="lineno">  134 </span>    -&gt; ByteString
<span class="lineno">  135 </span>        -- ^ Output Address. See also: 'fromBase58', 'fromBase16', 'fromBech32'.
<span class="lineno">  136 </span>    -&gt; Maybe (Output Shelley)
<span class="lineno">  137 </span><span class="decl"><span class="istickedoff">mkOutput coin bytes =</span>
<span class="lineno">  138 </span><span class="spaces">    </span><span class="istickedoff">Cardano.deserialiseFromRawBytes Cardano.AsShelleyAddress bytes &gt;&gt;= \case</span>
<span class="lineno">  139 </span><span class="spaces">        </span><span class="istickedoff">Cardano.ShelleyAddress _ (Ledger.ScriptHashObj _) _ -&gt; <span class="nottickedoff">Nothing</span></span>
<span class="lineno">  140 </span><span class="spaces">        </span><span class="istickedoff">addr@(Cardano.ByronAddress _) -&gt;</span>
<span class="lineno">  141 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">pure $ Cardano.TxOut addr (Cardano.Lovelace $ fromIntegral coin)</span></span>
<span class="lineno">  142 </span><span class="spaces">        </span><span class="istickedoff">addr@(Cardano.ShelleyAddress _ (Ledger.KeyHashObj _) _) -&gt;</span>
<span class="lineno">  143 </span><span class="spaces">            </span><span class="istickedoff">pure $ Cardano.TxOut addr (Cardano.Lovelace $ fromIntegral coin)</span></span>
<span class="lineno">  144 </span>
<span class="lineno">  145 </span>-- | Construct a 'SignKey' for /Shelley/ from primitive types.
<span class="lineno">  146 </span>-- This is for Shelley era keys.
<span class="lineno">  147 </span>--
<span class="lineno">  148 </span>-- __example__:
<span class="lineno">  149 </span>--
<span class="lineno">  150 </span>-- &gt;&gt;&gt; mkShelleySignKey =&lt;&lt; fromBech32 &quot;xprv13f0ve...nu4v4h875l&quot;
<span class="lineno">  151 </span>-- Just (SignKey ...)
<span class="lineno">  152 </span>--
<span class="lineno">  153 </span>-- @since 2.0.0
<span class="lineno">  154 </span>mkShelleySignKey
<span class="lineno">  155 </span>    :: ByteString
<span class="lineno">  156 </span>        -- ^ A extended address private key and its chain code.
<span class="lineno">  157 </span>        -- The key __must be 96 bytes__ long, internally made of two concatenated parts:
<span class="lineno">  158 </span>        --
<span class="lineno">  159 </span>        -- @
<span class="lineno">  160 </span>        -- BYTES = PRV | CC
<span class="lineno">  161 </span>        -- PRV   = 64OCTET  # a 64 bytes Ed25519 extended private key
<span class="lineno">  162 </span>        -- CC    = 32OCTET  # a 32 bytes chain code
<span class="lineno">  163 </span>        -- @
<span class="lineno">  164 </span>        --
<span class="lineno">  165 </span>        -- See also: 'fromBech32'.
<span class="lineno">  166 </span>    -&gt; Maybe (SignKey Shelley)
<span class="lineno">  167 </span><span class="decl"><span class="istickedoff">mkShelleySignKey = fmap</span>
<span class="lineno">  168 </span><span class="spaces">    </span><span class="istickedoff">( ShelleySigningKey</span>
<span class="lineno">  169 </span><span class="spaces">    </span><span class="istickedoff">. Cardano.WitnessPaymentExtendedKey</span>
<span class="lineno">  170 </span><span class="spaces">    </span><span class="istickedoff">. Cardano.PaymentExtendedSigningKey</span>
<span class="lineno">  171 </span><span class="spaces">    </span><span class="istickedoff">) . xprvFromBytes</span></span>
<span class="lineno">  172 </span>
<span class="lineno">  173 </span>-- | Construct a 'SignKey' for /Shelley/ from primitive types.
<span class="lineno">  174 </span>-- This is for Byron era keys.
<span class="lineno">  175 </span>--
<span class="lineno">  176 </span>-- __example__:
<span class="lineno">  177 </span>--
<span class="lineno">  178 </span>-- &gt;&gt;&gt; let (Just addr) = fromBase58 &quot;DdzFFzCqrh...Dwg3SiaHiEL&quot;
<span class="lineno">  179 </span>-- &gt;&gt;&gt; mkByronSignKey addr =&lt;&lt; fromBech32 &quot;xprv13f0ve...nu4v4h875l&quot;
<span class="lineno">  180 </span>-- Just (SignKey ...)
<span class="lineno">  181 </span>--
<span class="lineno">  182 </span>-- @since 2.0.0
<span class="lineno">  183 </span>mkByronSignKey
<span class="lineno">  184 </span>    :: AddrAttributes
<span class="lineno">  185 </span>        -- ^ Address attributes, obtained from a Byron address.
<span class="lineno">  186 </span>        -- See also: 'mkAddrAttributes'
<span class="lineno">  187 </span>    -&gt; ByteString
<span class="lineno">  188 </span>        -- ^ A extended address private key and its chain code.
<span class="lineno">  189 </span>        -- The key __must be 96 bytes__ long, internally made of two concatenated parts:
<span class="lineno">  190 </span>        --
<span class="lineno">  191 </span>        -- @
<span class="lineno">  192 </span>        -- BYTES = PRV | CC
<span class="lineno">  193 </span>        -- PRV   = 64OCTET  # a 64 bytes Ed25519 extended private key
<span class="lineno">  194 </span>        -- CC    = 32OCTET  # a 32 bytes chain code
<span class="lineno">  195 </span>        -- @
<span class="lineno">  196 </span>        --
<span class="lineno">  197 </span>        -- See also: 'fromBase16'.
<span class="lineno">  198 </span>    -&gt; Maybe (SignKey Shelley)
<span class="lineno">  199 </span><span class="decl"><span class="istickedoff">mkByronSignKey addrAttrs = do</span>
<span class="lineno">  200 </span><span class="spaces">    </span><span class="istickedoff">fmap (ByronSigningKey addrAttrs . SigningKey) . xprvFromBytes</span></span>
<span class="lineno">  201 </span>
<span class="lineno">  202 </span>-- | Extract address attributes from an address, if they exists (i.e. if the
<span class="lineno">  203 </span>-- address is a bootstrap / Byron address).
<span class="lineno">  204 </span>--
<span class="lineno">  205 </span>-- __example__:
<span class="lineno">  206 </span>--
<span class="lineno">  207 </span>-- &gt;&gt;&gt; let (Just addr) = fromBase58 &quot;DdzFFzCqrh...Dwg3SiaHiEL&quot;
<span class="lineno">  208 </span>-- &gt;&gt;&gt; mkAddrAttributes addr
<span class="lineno">  209 </span>-- Just (AddrAttributes ...)
<span class="lineno">  210 </span>--
<span class="lineno">  211 </span>-- @since 2.0.0
<span class="lineno">  212 </span>mkAddrAttributes
<span class="lineno">  213 </span>    :: ByteString
<span class="lineno">  214 </span>        -- ^ A Byron address, as a raw 'ByteString'.
<span class="lineno">  215 </span>    -&gt; Maybe AddrAttributes
<span class="lineno">  216 </span><span class="decl"><span class="istickedoff">mkAddrAttributes =</span>
<span class="lineno">  217 </span><span class="spaces">    </span><span class="istickedoff">getAddrAttributes . Address</span></span>
<span class="lineno">  218 </span>
<span class="lineno">  219 </span>--
<span class="lineno">  220 </span>-- MkPayment instance
<span class="lineno">  221 </span>--
<span class="lineno">  222 </span>
<span class="lineno">  223 </span>-- Type-level constructor capturing types for 'Shelley'.
<span class="lineno">  224 </span>data Shelley
<span class="lineno">  225 </span>
<span class="lineno">  226 </span>instance MkPayment Shelley where
<span class="lineno">  227 </span>    type Init Shelley = (NetworkId, SlotNo, Fee)
<span class="lineno">  228 </span>
<span class="lineno">  229 </span>    type Input   Shelley = TxIn
<span class="lineno">  230 </span>    type Output  Shelley = TxOut Cardano.Shelley
<span class="lineno">  231 </span>    type SignKey Shelley = CardanoSigningKey
<span class="lineno">  232 </span>
<span class="lineno">  233 </span>    type CoinSel Shelley =
<span class="lineno">  234 </span>        (NetworkId, SlotNo, Fee, [TxIn], [TxOut Cardano.Shelley])
<span class="lineno">  235 </span>
<span class="lineno">  236 </span>    type Tx Shelley = Either
<span class="lineno">  237 </span>        ErrMkPayment
<span class="lineno">  238 </span>        ( NetworkId
<span class="lineno">  239 </span>        , [TxIn]
<span class="lineno">  240 </span>        , [TxOut Cardano.Shelley]
<span class="lineno">  241 </span>        , Cardano.TxBody Cardano.Shelley
<span class="lineno">  242 </span>        , [Cardano.Witness Cardano.Shelley]
<span class="lineno">  243 </span>        )
<span class="lineno">  244 </span>
<span class="lineno">  245 </span>    empty :: Init Shelley -&gt; CoinSel Shelley
<span class="lineno">  246 </span>    <span class="decl"><span class="istickedoff">empty (net, ttl, fee) = (<span class="nottickedoff">net</span>, ttl, fee, mempty, mempty)</span></span>
<span class="lineno">  247 </span>
<span class="lineno">  248 </span>    addInput :: TxIn -&gt; CoinSel Shelley -&gt; CoinSel Shelley
<span class="lineno">  249 </span>    <span class="decl"><span class="istickedoff">addInput inp (pm, ttl, fee, inps, outs) = (<span class="nottickedoff">pm</span>, ttl, fee, inp : inps, outs)</span></span>
<span class="lineno">  250 </span>
<span class="lineno">  251 </span>    addOutput :: TxOut Cardano.Shelley -&gt; CoinSel Shelley -&gt; CoinSel Shelley
<span class="lineno">  252 </span>    <span class="decl"><span class="istickedoff">addOutput out (pm, ttl, fee, inps, outs) = (<span class="nottickedoff">pm</span>, ttl, fee, inps, out : outs)</span></span>
<span class="lineno">  253 </span>
<span class="lineno">  254 </span>    lock :: CoinSel Shelley -&gt; Tx Shelley
<span class="lineno">  255 </span>    <span class="decl"><span class="istickedoff">lock (_net, _ttl, _fee, [], _outs) = Left MissingInput</span>
<span class="lineno">  256 </span><span class="spaces">    </span><span class="istickedoff">lock (_net, _ttl, _fee, _inps, []) = Left MissingOutput</span>
<span class="lineno">  257 </span><span class="spaces">    </span><span class="istickedoff">lock (net, ttl, fee, inps, outs) = Right (<span class="nottickedoff">net</span>, inps', <span class="nottickedoff">outs'</span>, sigData, mempty)</span>
<span class="lineno">  258 </span><span class="spaces">      </span><span class="istickedoff">where</span>
<span class="lineno">  259 </span><span class="spaces">        </span><span class="istickedoff">inps'   = reverse inps</span>
<span class="lineno">  260 </span><span class="spaces">        </span><span class="istickedoff">outs'   = reverse outs</span>
<span class="lineno">  261 </span><span class="spaces">        </span><span class="istickedoff">sigData = Cardano.makeShelleyTransaction</span>
<span class="lineno">  262 </span><span class="spaces">            </span><span class="istickedoff">TxExtraContent</span>
<span class="lineno">  263 </span><span class="spaces">                </span><span class="istickedoff">{ txMetadata = Nothing -- TO DO: add metadata support</span>
<span class="lineno">  264 </span><span class="spaces">                </span><span class="istickedoff">, txWithdrawals = [] -- TO DO: add withdrawal support</span>
<span class="lineno">  265 </span><span class="spaces">                </span><span class="istickedoff">, txCertificates = []</span>
<span class="lineno">  266 </span><span class="spaces">                </span><span class="istickedoff">, txUpdateProposal = Nothing</span>
<span class="lineno">  267 </span><span class="spaces">                </span><span class="istickedoff">}</span>
<span class="lineno">  268 </span><span class="spaces">            </span><span class="istickedoff">ttl</span>
<span class="lineno">  269 </span><span class="spaces">            </span><span class="istickedoff">(Cardano.Lovelace $ unFee fee)</span>
<span class="lineno">  270 </span><span class="spaces">            </span><span class="istickedoff">inps'</span>
<span class="lineno">  271 </span><span class="spaces">            </span><span class="istickedoff">outs'</span></span>
<span class="lineno">  272 </span>
<span class="lineno">  273 </span>    signWith :: SignKey Shelley -&gt; Tx Shelley -&gt; Tx Shelley
<span class="lineno">  274 </span>    <span class="decl"><span class="istickedoff">signWith _ (Left e) = <span class="nottickedoff">Left e</span></span>
<span class="lineno">  275 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  276 </span><span class="spaces">    </span><span class="istickedoff">signWith (ShelleySigningKey skey) (Right (net, inps, outs, sigData, wits)) =</span>
<span class="lineno">  277 </span><span class="spaces">        </span><span class="istickedoff">Right (<span class="nottickedoff">net</span>, inps, <span class="nottickedoff">outs</span>, sigData, shelleyWit : wits)</span>
<span class="lineno">  278 </span><span class="spaces">      </span><span class="istickedoff">where</span>
<span class="lineno">  279 </span><span class="spaces">        </span><span class="istickedoff">shelleyWit = Cardano.makeShelleyKeyWitness sigData skey</span>
<span class="lineno">  280 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  281 </span><span class="spaces">    </span><span class="istickedoff">signWith (ByronSigningKey addrAttrs skey) (Right (net, inps, outs, sigData, wits)) =</span>
<span class="lineno">  282 </span><span class="spaces">        </span><span class="istickedoff">Right (<span class="nottickedoff">net</span>, inps, <span class="nottickedoff">outs</span>, sigData, byronWit : wits)</span>
<span class="lineno">  283 </span><span class="spaces">      </span><span class="istickedoff">where</span>
<span class="lineno">  284 </span><span class="spaces">        </span><span class="istickedoff">byronWit = Cardano.ShelleyBootstrapWitness $</span>
<span class="lineno">  285 </span><span class="spaces">            </span><span class="istickedoff">Ledger.makeBootstrapWitness txHash skey attrs</span>
<span class="lineno">  286 </span><span class="spaces">        </span><span class="istickedoff">Cardano.ShelleyTxBody body _ = sigData</span>
<span class="lineno">  287 </span><span class="spaces">        </span><span class="istickedoff">txHash = Ledger.eraIndTxBodyHash body</span>
<span class="lineno">  288 </span><span class="spaces">        </span><span class="istickedoff">attrs  = mkAttributes addrAttrs</span></span>
<span class="lineno">  289 </span>
<span class="lineno">  290 </span>    serialize :: Tx Shelley -&gt; Either ErrMkPayment ByteString
<span class="lineno">  291 </span>    <span class="decl"><span class="istickedoff">serialize (Left e) = Left e</span>
<span class="lineno">  292 </span><span class="spaces">    </span><span class="istickedoff">serialize (Right (_net, inps, _outs, sigData, wits))</span>
<span class="lineno">  293 </span><span class="spaces">        </span><span class="istickedoff">| length inps /= length wits = Left MissingSignature</span>
<span class="lineno">  294 </span><span class="spaces">        </span><span class="istickedoff">| <span class="tickonlytrue">otherwise</span> = Right $ Cardano.serialiseToCBOR tx</span>
<span class="lineno">  295 </span><span class="spaces">      </span><span class="istickedoff">where</span>
<span class="lineno">  296 </span><span class="spaces">        </span><span class="istickedoff">tx = Cardano.makeSignedTransaction wits sigData</span></span>

</pre>
</body>
</html>
